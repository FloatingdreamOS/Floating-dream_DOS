;Floating dream-DOS
;Copyright © 2022 Floatingdream All Rights Reserved.
;floatingdream.vxz.vin
PROGRAMSEGMENT	EQU	4500H
APPSEARCH:
	MOV	AH,[FILEINFOSEG]
	MOV	AL,[FILEINFOSEG+1]
	MOV	ES,AX
	MOV	SI,0
	MOV	DI,0
.BIN:	; 判断文件后缀是否为.COM
	MOV	AL,[ES:8]
	CMP	AL,'C'
	JNE	.NEXT
	MOV	AL,[ES:9]
	CMP	AL,'O'
	JNE	.NEXT
	MOV	AL,[ES:10]
	CMP	AL,'M'
	JNE	.NEXT
	MOV	AL,[ES:11]
	CMP	AL,' '
	JNE	.NEXT
.LOOP:
	MOV	CX,8
.CMP:
	MOV	AH,[CMDLINE+DI]
	AND	AH,11011111B	; 大写
	MOV	AL,[ES:SI]
	CMP	AL,' '
	JE	.SUFFIX
	CMP	AL,AH
	JNE	.NEXT
	INC	SI
	INC	DI
	LOOP	.CMP
.SUFFIX:	; 判断输入的后缀是否为.COM
	CMP	BYTE[CMDLINE+DI],0
	JE	.OK
	CMP	BYTE[CMDLINE+DI],' '
	JE	.OK
	CMP	BYTE[CMDLINE+DI],'.'
	JNE	.END
	INC	DI
	MOV	AH,[CMDLINE+DI]
	AND	AH,11011111B
	CMP	AH,'C'
	JNE	.END
	INC	DI
	MOV	AH,[CMDLINE+DI]
	AND	AH,11011111B
	CMP	AH,'O'
	JNE	.END
	INC	DI
	MOV	AH,[CMDLINE+DI]
	AND	AH,11011111B
	CMP	AH,'M'
	JNE	.END
	JMP	.OK
.NEXT:
	MOV	AX,ES
	ADD	AX,2H	; 指向下一个文件
	MOV	ES,AX
	MOV	SI,0
	MOV	AL,[ES:SI]
	CMP	AL,0
	JE	.END
	MOV	DI,0
	JMP	.BIN
.OK:	; 计算文件段地址
	MOV	AX,ES
	ADD	AX,1H
	MOV	ES,AX
	MOV	SI,10
	MOV	CX,[ES:SI]
	MOV	AX,0
.MUL:
	ADD	AX,20H	; 一个扇区
	LOOP	.MUL
	ADD	AX,FILETYPESEG
	MOV	ES,AX
	MOV	SI,0
	MOV	CX,12
.SAWLOOP:
	MOV	AL,[ES:SI]
	MOV	AH,[APPFILEHEAD+SI]	
	CMP	AH,AL
	JNE	.NOTAPP
	INC	SI
	LOOP	.SAWLOOP
	
	MOV	AX,ES	; 将程序复制到0x45000处再执行
	MOV	DS,AX
	MOV	SI,0
	MOV	AX,PROGRAMSEGMENT
	MOV	ES,AX
	MOV	DI,0
	MOV	CX,0xFFFF
	CALL	MEMCPY
	
	PUSH	DS
	JMP	DWORD PROGRAMSEGMENT:12	; 规定了程序地址 只需跳转到规定地址即可
								
	POP	DS
.JMP:
	MOV	AH,02H
	INT	36H
	MOV	SI,LINEPUT
	MOV	AH,01H
	INT	36H
	MOV	SI,0
	JMP USRINPUT
.NOTAPP:
	MOV	SI,NOTAPPPUT
	MOV AH, 09H			; 绘制
	MOV BH, 0
	MOV CX, 10000
	MOV BL, 00011111b
	MOV AL, ' '
	INT 10H				;
	MOV	AH,01H
	INT	36H
	MOV	AH,02H
	INT	36H
	INT	36H
	JMP	USRINPUT
.END:
	RET

BATSEARCH:
	MOV	AH,[FILEINFOSEG]
	MOV	AL,[FILEINFOSEG+1]
	MOV	ES,AX
	MOV	SI,0
	MOV	DI,0
.BAT:	; 判断文件后缀是否为.BAT
	MOV	AL,[ES:8]
	CMP	AL,'B'
	JNE	.NEXT
	MOV	AL,[ES:9]
	CMP	AL,'A'
	JNE	.NEXT
	MOV	AL,[ES:10]
	CMP	AL,'T'
	JNE	.NEXT
	MOV	AL,[ES:11]
	CMP	AL,' '
	JNE	.NEXT
.LOOP:
	MOV	CX,8
.CMP:
	MOV	AH,[CMDLINE+DI]
	AND	AH,11011111B     	;大写
	MOV	AL,[ES:SI]
	CMP	AL,' '
	JE	.SUFFIX
	CMP	AL,AH
	JNE	.NEXT
	INC	SI
	INC	DI
	LOOP	.CMP
.SUFFIX:	; 判断输入的后缀是否为.BAT
	CMP	BYTE[CMDLINE+DI],0	; 没有输后缀也可以
	JE	.OK
	CMP	BYTE[CMDLINE+DI],' '
	JE	.OK
	CMP	BYTE[CMDLINE+DI],'.'
	JNE	.END
	INC	DI
	MOV	AH,[CMDLINE+DI]
	AND	AH,11011111B
	CMP	AH,'B'
	JNE	.END
	INC	DI
	MOV	AH,[CMDLINE+DI]
	AND	AH,11011111B
	CMP	AH,'A'
	JNE	.END
	INC	DI
	MOV	AH,[CMDLINE+DI]
	AND	AH,11011111B
	CMP	AH,'T'
	JNE	.END
	JMP	.OK
.NEXT:
	MOV	AX,ES
	ADD	AX,2H	; 指向下一个文件
	MOV	ES,AX
	MOV	SI,0
	MOV	AL,[ES:SI]
	CMP	AL,0
	JE	.END
	MOV	DI,0
	JMP	.BAT
.OK:	; 计算文件段地址
	MOV	AX,ES
	ADD	AX,1H
	MOV	ES,AX
	MOV	SI,10
	MOV	CX,[ES:SI]
	MOV	AX,0
.MUL:
	ADD	AX,20H	; 一个扇区
	LOOP	.MUL
	ADD	AX,FILETYPESEG
	MOV	ES,AX
	MOV	SI,0
	MOV	DI,0
.LINE:
	MOV	AH,[ES:SI]	; 获取当前字符
	CMP	AH,0
	JE	.RET
	CMP	AH,'#'	; '#'字为注释
	JE	.NEXTLINE
	CMP	AH,0DH		; 以换行为结束标志
	JE	.LINEOK
	MOV	[CMDLINE+DI],AH
	INC	SI
	INC	DI
	JMP	.LINE
.NEXTLINE:
	MOV	AH,[ES:SI]
	INC	SI
	CMP	AH,0DH
	JNE	.NEXTLINE
	INC	SI
	JMP	.LINE
.LINEOK:
	ADD	SI,2	; 0DH,0AH +2
	PUSH	ES	
	PUSH	SI	
	CALL	APPSEARCH
	CALL	COMMAND
	CALL	CLEANINPUT
	POP	SI		
	POP	ES		
	MOV	DI,0
	JMP	.LINE
.RET:
	MOV	AH,02H
	INT	36H
	CMP	BYTE[DEBUGFLAGS],1
	JE	.DEBUGMODE
	MOV	SI,LINEPUT
	MOV	AH,01H
	INT	36H
	MOV	SI,0
	JMP USRINPUT
.DEBUGMODE:
	MOV	SI,DEBUGMODEPUT
	MOV	AH,01H
	INT	36H
	MOV	SI,0
	JMP	USRINPUT
.END:
	RET